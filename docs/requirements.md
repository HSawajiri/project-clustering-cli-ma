# 要件定義書

**バージョン:** 1.3
**作成日:** 2026-02-06
**最終更新日:** 2026-02-06

---

## 1. プロジェクト概要

### 1.1 プロジェクト名
プロジェクト名クラスタリング CLI ツール（project-clustering-cli）

### 1.2 目的・背景
**目的:**
受注データのプロジェクト名表記揺れを検出し、TF-IDF + コサイン類似度によるクラスタリングを行う、コマンドライン実行可能なバッチ処理ツールを提供する。

**背景:**
- 現状: FlaskベースのWebアプリケーション（`excel-clustering-app`）が存在するが、GUI操作が必要
- 課題: サーバー起動やブラウザ操作が不要な、シンプルなバッチ実行環境が求められている
- 解決策: .exeファイルとCSVファイルを同じフォルダに配置して実行するだけで、クラスタリング結果を出力

### 1.3 対象範囲
- 既存の `excel-clustering-app` プロジェクトのクラスタリングロジック（preprocessor.py、clustering.py）を流用
- CSV入力ファイルの自動検出と読み込み
- 前処理（半角全角変換、スペース削除、時期・フェーズ情報除去など）
- TF-IDFベクトル化とコサイン類似度によるクラスタリング
- クラスタリング結果のCSV出力（タイムスタンプ付き）
- config.yamlによる設定管理
- .exe化（PyInstaller）

### 1.4 対象外範囲
- GUI（Webインターフェース、デスクトップアプリ）
- サーバー機能（Flask、API）
- データベース連携
- リアルタイム処理
- 既存の `excel-clustering-app` プロジェクトの改修
- クラスタリングアルゴリズムの変更・改良

---

## 2. ステークホルダー

| 役割 | 担当者 | 責任範囲 |
|------|--------|---------|
| プロジェクトオーナー | ユーザー | プロジェクト全体の意思決定、要件承認 |
| 開発担当 | Claude Code | 要件定義、設計、実装、テスト |
| エンドユーザー | データ分析担当者、社内の非エンジニア | ツールの利用、フィードバック提供 |

---

## 3. 機能要件

### FR-001: CSV入力データ読み込み
**概要:**
同じフォルダ内のCSVファイルを自動検出または指定して読み込む

**詳細:**
- 入力ファイル形式: CSV（UTF-8 with BOM、Shift-JIS対応）
- 必須列: `オーダーID`, `会社名`, `作業名称`
- config.yamlで入力ファイル名を指定可能（空の場合は自動検出）
- .exeと同じフォルダ内のCSVファイルを検索

**優先度:**
- [x] 必須（Must）

**受け入れ基準:**
1. UTF-8 with BOMおよびShift-JISエンコーディングのCSVを正しく読み込める
2. 必須列（オーダーID、会社名、作業名称）が存在しない場合はエラーメッセージを表示
3. config.yamlでinput_fileが空の場合、同フォルダ内の.csvファイルを自動検出
4. ファイルが見つからない場合は適切なエラーメッセージを表示

---

### FR-002: テキスト前処理
**概要:**
プロジェクト名の表記揺れを正規化（処理順序を最適化し、長音記号を保護）

**詳細:**
前処理オプション（config.yamlで設定可能）:

**処理順序（最適化済み）:**
1. **スペース削除** (remove_spaces): 全角・半角スペースを削除
2. **時期情報除去** (remove_period): FY2024、令和6年度、5月度、1Qなどを削除
3. **フェーズ情報除去** (remove_phase): 要件定義、基本設計、詳細設計、テストなどを削除
4. **記号・装飾除去** (remove_symbols): ／、-、【】、()などを削除（**長音記号「ー」は保護**）
5. **半角→全角変換** (normalize_width): 英数字・記号を全角に統一（パターンマッチ後に実行）
6. **略語正規化** (normalize_abbreviations): S→システム、HR→人事、CRM→顧客管理など（30+パターン）

**対応パターン（半角・全角両対応）:**
- **時期**: FY2024/ＦＹ２０２４, 令和6年度, 5月度/５月度, 1Q/１Ｑ, 第1四半期
- **フェーズ**: 要件定義、基本設計、詳細設計、開発、テスト、移行、保守、運用、PMO
- **英語・略称**: RequirementDefinition, BD, DD, PG, ST, IT, O&M等

**重要な仕様（v1.3で改善）:**
- **処理順序の最適化**: 半角のうちに時期・フェーズ除去を実行し、その後に全角化することでパターンマッチの精度を向上
- **長音記号の保護**: カタカナ語（バージョン、フェーズ等）が破壊されないよう区切り記号パターンから「ー」を除外
- **月度・四半期対応**: 実データに対応するため月度・四半期パターンを追加

**優先度:**
- [x] 必須（Must）

**受け入れ基準:**
1. config.yamlの各オプション（true/false）が正しく反映される
2. 前処理後のテキストが正規化されている
3. 長音記号が保護されカタカナ語が破壊されない
4. 時期・フェーズ情報が完全に除去される

---

### FR-003: TF-IDFベクトル化とクラスタリング
**概要:**
既存のclustering.pyロジックを流用し、TF-IDF + コサイン類似度による階層的クラスタリングを実行

**詳細:**
- TF-IDFベクトル化（scikit-learn）
- コサイン類似度計算
- 会社ごとにグルーピング（同じ会社内でクラスタリング）
- 階層的クラスタリング（AgglomerativeClustering）
- クラスタIDと代表名（最頻出の作業名称）を付与

**優先度:**
- [x] 必須（Must）

**受け入れ基準:**
1. 既存のclustering.pyロジックをそのまま流用して動作する
2. 会社ごとに独立してクラスタリングが行われる
3. 各クラスタにIDと代表名が正しく付与される
4. クラスタリング結果が論理的に妥当である

---

### FR-004: クラスタリング結果の出力
**概要:**
クラスタリング結果をタイムスタンプ付きCSVファイルとして出力

**詳細:**
- 出力形式: CSV（UTF-8 with BOM）
- 出力列: 元のCSV列 + `クラスタID` + `代表名`
- ファイル名: `{output_prefix}_YYYYMMDD_HHMMSS.csv`（config.yamlで設定可能）
- タイムスタンプ付与のON/OFF切り替え可能（config.yaml）

**優先度:**
- [x] 必須（Must）

**受け入れ基準:**
1. 出力CSVにクラスタIDと代表名が追加されている
2. UTF-8 with BOMエンコーディングで正しく出力される
3. config.yamlの設定に応じてファイル名が生成される
4. タイムスタンプのフォーマットがYYYYMMDD_HHMMSSである

---

### FR-005: 設定ファイル（config.yaml）管理
**概要:**
config.yamlで前処理オプション、入出力設定、ログ設定を管理

**詳細:**
設定項目:
- **preprocessing**: 前処理オプション（各種true/false）
- **io**: 入力ファイル名、出力ファイル接頭辞、タイムスタンプ付与
- **logging**: コンソール出力、ファイル出力、ログレベル

**優先度:**
- [x] 必須（Must）

**受け入れ基準:**
1. config.yamlが存在しない場合はデフォルト設定で動作
2. 設定ファイルの各項目が正しくプログラムに反映される
3. 不正な設定値の場合は適切なエラーメッセージを表示

---

### FR-006: ログ出力
**概要:**
処理状況をコンソールとファイルの両方にログ出力

**詳細:**
- ログレベル: INFO, WARNING, ERROR
- コンソール出力: 処理進捗をリアルタイム表示
- ファイル出力: `clustering.log`（config.yamlで設定可能）
- タイムスタンプ、ログレベル、メッセージを含む

**優先度:**
- [x] 必須（Must）

**受け入れ基準:**
1. コンソールとファイルの両方にログが出力される
2. config.yamlでログ出力先（console/file）をON/OFF可能
3. エラー発生時にスタックトレースがログに記録される
4. ログファイルが肥大化しない（必要に応じてローテーション）

---

### FR-007: 企業別クラスタ数調整
**概要:**
企業ごとにクラスタリング数を自動計算値から調整、または固定値で指定できる機能

**詳細:**
- **デフォルト動作**: クラスタ数は企業ごとに自動計算される
  - 既存の `calculate_default_clusters()` メソッドを使用
  - デンドログラムの距離増加率で最適なクラスタ数を決定
  - 制約: 2〜データ件数*0.5の範囲

- **config.yamlでの調整**: 2つのモードをサポート
  1. **オフセットモード**: 自動計算値からの増減
     - 文字列で `"+2"`, `"-1"` のように指定
     - 例: 自動計算値が5の場合、`"+2"` → 7クラスタ

  2. **固定モード**: クラスタ数を強制的に指定
     - 数値で `7` のように指定
     - 例: `7` → 常に7クラスタ

- **設定例**:
  ```yaml
  clustering:
    company_cluster_settings:
      "みらい銀行": "+2"          # 自動計算値 + 2
      "東京システム株式会社": 7    # 固定で7クラスタ
      "ABC株式会社": "-1"         # 自動計算値 - 1
  ```

- **設定されていない企業**: 自動計算値をそのまま使用
- **クラスタ数の制約**: 最終的なクラスタ数は1以上に制御

**優先度:**
- [x] 重要（Should）

**受け入れ基準:**
1. config.yamlで企業別のクラスタ数設定を指定できる
2. 設定なしの企業は `calculate_default_clusters()` で自動計算される
3. オフセットモード（文字列 `"+2"`, `"-1"`）が正しく動作する
4. 固定モード（数値 `7`）が正しく動作する
5. クラスタ数が1未満にならないように制御される
6. 企業名の完全一致で判定される（大文字小文字区別あり）
7. ログに各企業の「自動計算値」「調整後の値」が出力される

---

### FR-008: .exe化（PyInstaller）
**概要:**
PyInstallerを使用して、Windowsで実行可能な.exeファイルを生成

**詳細:**
- 単一の.exeファイルにパッケージング（ワンファイル形式）
- 実行に必要な依存ライブラリを全て含む
- config.yamlは.exeと同じフォルダに配置
- Windows環境での動作を想定

**優先度:**
- [x] 必須（Must）

**受け入れ基準:**
1. `pyinstaller build.spec` でエラーなく.exeファイルが生成される
2. 生成された.exeファイルがWindows環境で正常に動作する
3. Pythonがインストールされていない環境でも実行可能
4. .exeと同じフォルダにconfig.yamlを配置すれば設定が反映される

---

## 4. 非機能要件

### NFR-001: パフォーマンス
**概要:**
大量データの処理を現実的な時間内で完了する

**詳細:**
- 処理時間: 1000行のCSVを30秒以内に処理
- メモリ使用量: 一般的なPC（RAM 8GB）で動作可能
- CPU使用率: 処理中は高負荷を許容（バッチ処理のため）

**測定方法:**
- テストデータ（1000行）を用いた処理時間計測
- Windows Task Managerでメモリ使用量を確認

---

### NFR-002: 可用性
**概要:**
ローカル実行ツールのため、ネットワーク依存なしで動作

**詳細:**
- オフライン実行: インターネット接続不要
- 外部サービス依存: なし
- 単独実行: Pythonインストール不要（.exe化）

---

### NFR-003: セキュリティ
**概要:**
ローカルファイル処理のため、最小限のセキュリティ要件

**詳細:**
- 認証: 不要（ローカル実行）
- データ暗号化: 不要（ローカルファイル）
- 入力検証: CSVフォーマットの検証、不正データのエラーハンドリング
- ログファイル: 機密情報（個人情報等）をログに出力しない

---

### NFR-004: 拡張性
**概要:**
将来的な機能追加に対応できる設計

**詳細:**
- データ量: 現在1000行、将来的に10000行まで対応
- 設定ファイル: config.yamlで柔軟に設定変更可能
- モジュール化: 前処理・クラスタリングロジックを独立したモジュールとして管理

---

### NFR-005: 保守性
**概要:**
既存コードの流用と、将来的なメンテナンスのしやすさ

**詳細:**
- コーディング規約: PEP 8準拠
- ドキュメント: README.md、要件定義書、仕様書を整備
- ログ出力: デバッグに必要な情報を適切にログ出力
- 既存コード流用: preprocessor.pyとclustering.pyを変更せずに流用

**保守性の指標:**
- 新しい前処理ルールの追加が容易
- config.yamlで動作変更が可能
- エラーログから問題箇所を特定可能

---

### NFR-006: ユーザビリティ
**概要:**
非エンジニアでも簡単に使用できる

**詳細:**
- 実行方法: .exeをダブルクリックまたはコマンドラインから実行
- 設定方法: config.yamlをテキストエディタで編集
- エラーメッセージ: わかりやすい日本語メッセージ
- ログ出力: コンソールに処理進捗を表示

**受け入れ基準:**
1. データ分析担当者（非エンジニア）が説明書なしで実行できる
2. エラー発生時に、ログを見れば原因を特定できる
3. config.yamlのコメントを読めば設定方法が理解できる

---

## 5. 制約条件

### 5.1 技術的制約
- **プログラミング言語**: Python 3.11以上
- **既存コード流用**: `excel-clustering-app` の preprocessor.py と clustering.py をそのまま使用
- **ロジック変更禁止**: 既存のクラスタリングロジックを変更しない
- **実行環境**: Windows環境での動作を想定（.exe）
- **パッケージマネージャ**: pip
- **.exe化ツール**: PyInstaller

### 5.2 スケジュール制約
- プロジェクト開始日: 2026-02-06
- リリース予定日: 未定（要件定義完了後に設定）
- マイルストーン:
  - M1: 要件定義完了
  - M2: 設計完了
  - M3: 実装完了
  - M4: テスト完了
  - M5: .exe化完了

### 5.3 予算制約
- 総予算: なし（個人プロジェクト）
- 開発費: なし
- インフラ費: なし（ローカル実行）

### 5.4 その他の制約
- **既存プロジェクト保持**: `excel-clustering-app` プロジェクトはそのまま保持（変更しない）
- **依存ライブラリ**: 既存アプリと同じバージョン（pandas 2.1.3, scikit-learn 1.3.2など）
- **データ形式**: CSV入力・CSV出力のみ対応（Excel等は対象外）

---

## 6. 前提条件・依存関係

### 6.1 前提条件
- **既存プロジェクト**: `~/projects/excel-clustering-app` が存在し、preprocessor.py と clustering.py が動作可能
- **開発環境**: VS Code + Dev Container
- **実行環境**: Windows OS（.exe実行時）
- **入力データ**: CSV形式で、必須列（オーダーID、会社名、作業名称）が存在

### 6.2 外部システム依存
- なし（完全にローカル実行）

### 6.3 リソース依存
- **既存コード**:
  - `~/projects/excel-clustering-app/src/webapp/preprocessor.py`
  - `~/projects/excel-clustering-app/src/webapp/clustering.py`
- **テストデータ**: `~/projects/excel-clustering-app/shared/data/test_orders.csv`
- **Pythonライブラリ**:
  - pandas 2.1.3
  - numpy 1.26.2
  - scikit-learn 1.3.2
  - PyYAML 6.0.1
  - PyInstaller（最新版）

---

## 7. リスク管理

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|---------|------|
| 既存コード（preprocessor.py、clustering.py）が参照できない | 高 | 低 | Dev Container環境から既存プロジェクトをマウント、またはコードをコピー |
| PyInstallerでの.exe化に失敗 | 高 | 中 | 依存ライブラリの調整、build.specファイルの修正、代替ツール（cx_Freeze等）の検討 |
| 大量データ（10000行以上）の処理でパフォーマンス劣化 | 中 | 中 | バッチ処理の最適化、並列処理の導入、処理単位の分割 |
| CSVエンコーディングの自動検出に失敗 | 中 | 低 | chardetライブラリの導入、ユーザーにエンコーディング指定機能を追加 |
| Windows以外の環境（macOS、Linux）での実行要望 | 低 | 中 | PyInstallerで各OS向けバイナリを生成、またはPythonスクリプト実行を案内 |

---

## 8. 成功基準

### 8.1 定量的基準
- **処理時間**: 1000行のCSVを30秒以内に処理完了
- **成功率**: テストデータ（test_orders.csv）で100%正常動作
- **.exe化**: Windows環境でPythonなしで実行可能
- **テストカバレッジ**: 主要機能（前処理、クラスタリング、入出力）の単体テストを実施

### 8.2 定性的基準
- **既存ロジックの流用**: preprocessor.pyとclustering.pyのロジックが正しく動作
- **ユーザビリティ**: 非エンジニアが説明書を見て実行できる
- **保守性**: 新しい前処理ルールの追加が容易
- **エラーハンドリング**: エラー発生時に適切なメッセージとログが出力される
- **ドキュメント**: README.md、要件定義書、仕様書が整備されている

---

## 9. 変更履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|-----------|------|---------|--------|
| 1.0 | 2026-02-06 | 初版作成（initial-requirements.mdを基に要件定義書を作成） | Claude Code |
| 1.1 | 2026-02-06 | FR-007追加: 企業別クラスタ数調整機能を追加 | Claude Code |
| 1.2 | 2026-02-06 | FR-007修正: クラスタ数自動計算＋オフセット/固定モードに変更 | Claude Code |
| 1.3 | 2026-02-06 | FR-002改善: 処理順序最適化、長音記号保護、月度・四半期対応を反映 | Claude Code |

---

## 10. 承認

| 役割 | 氏名 | 署名 | 日付 |
|------|------|------|------|
| プロジェクトオーナー | ユーザー | ✅ 承認済み | 2026-02-06 |

---

## 11. 補足資料

### 11.1 処理フロー図

```
[開始]
  ↓
[1. config.yaml読み込み]
  ↓
[2. CSV入力ファイル検出/読み込み]
  ↓
[3. 前処理（preprocessor.py）]
  - 半角→全角変換
  - スペース削除
  - 時期情報除去
  - フェーズ情報除去
  - 記号・装飾除去
  - 略語正規化
  ↓
[4. クラスタリング（clustering.py）]
  - TF-IDFベクトル化
  - コサイン類似度計算
  - 会社ごとにグルーピング
  - 階層的クラスタリング
  ↓
[5. クラスタID・代表名付与]
  ↓
[6. CSV出力（タイムスタンプ付き）]
  ↓
[終了]
```

### 11.2 データフロー

```
[入力CSV]
  オーダーID, 会社名, 作業名称
  ↓
[前処理]
  作業名称 → 正規化テキスト
  ↓
[クラスタリング]
  正規化テキスト → クラスタID, 代表名
  ↓
[出力CSV]
  オーダーID, 会社名, 作業名称, クラスタID, 代表名
```

### 11.3 フォルダ構成（完成イメージ）

```
配布フォルダ/
├── clustering.exe                      # 実行ファイル
├── config.yaml                         # 設定ファイル
├── input.csv                           # 入力ファイル（ユーザーが配置）
├── output_clustered_20260206_153000.csv  # 出力ファイル
└── clustering.log                      # ログファイル
```
