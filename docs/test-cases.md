# テストケース仕様書

**バージョン:** 1.0
**作成日:** 2026-02-06
**作成者:** Tester SubAgent

---

## 1. 概要

本ドキュメントは、プロジェクト名クラスタリング CLI ツール（project-clustering-cli-ma）の包括的なテストケースを定義する。

**テスト対象:**
- 要件定義書 v1.3 (docs/requirements.md)
- 技術仕様書 v1.0 (docs/specification.md)
- 実装コード (src/ ディレクトリ)

---

## 2. テスト戦略

### 2.1 テスト種別

| テスト種別 | 対象 | カバレッジ目標 | 実施方法 |
|----------|------|--------------|---------|
| 単体テスト | 各モジュール | 80%以上 | pytest |
| 統合テスト | モジュール間連携 | 主要フロー100% | pytest |
| 受け入れテスト | 全機能要件 | FR-001〜FR-008 | 手動＋自動 |

### 2.2 テスト環境

- **Python:** 3.11+
- **テストフレームワーク:** pytest 7.4+
- **カバレッジツール:** pytest-cov
- **OS:** Linux (Dev Container)

---

## 3. 機能要件テストケース

### 3.1 FR-001: CSV入力データ読み込み

#### TC-FR001-001: UTF-8 with BOM エンコーディング読み込み
- **優先度:** High
- **目的:** UTF-8 with BOM形式のCSVを正しく読み込めることを確認
- **前提条件:** test_encoding_utf8.csv が存在（UTF-8 with BOM）
- **入力:** UTF-8 with BOM形式のCSVファイル
- **期待結果:** 正常に読み込まれ、文字化けしない
- **テストメソッド:** test_read_csv_utf8_bom

#### TC-FR001-002: Shift-JIS エンコーディング読み込み
- **優先度:** High
- **目的:** Shift-JIS形式のCSVを正しく読み込めることを確認
- **前提条件:** test_encoding_sjis.csv が存在（Shift-JIS）
- **入力:** Shift-JIS形式のCSVファイル
- **期待結果:** 正常に読み込まれ、文字化けしない
- **テストメソッド:** test_read_csv_shift_jis

#### TC-FR001-003: エンコーディング自動検出
- **優先度:** High
- **目的:** エンコーディングを自動判定できることを確認
- **前提条件:** 複数のエンコーディング形式のCSVファイルが存在
- **入力:** UTF-8 BOM、Shift-JIS、UTF-8のCSVファイル
- **期待結果:** 正しいエンコーディングが判定される
- **テストメソッド:** test_detect_encoding

#### TC-FR001-004: 必須列検証（正常系）
- **優先度:** High
- **目的:** 必須列が存在する場合に正常終了することを確認
- **前提条件:** オーダーID、会社名、作業名称を含むCSV
- **入力:** 必須列を全て含むCSVファイル
- **期待結果:** エラーが発生せず、データフレームが返される
- **テストメソッド:** test_validate_columns_success

#### TC-FR001-005: 必須列検証（異常系: オーダーID欠損）
- **優先度:** High
- **目的:** オーダーID列が存在しない場合にエラーが発生することを確認
- **前提条件:** オーダーID列を含まないCSV
- **入力:** オーダーID列が欠けているCSVファイル
- **期待結果:** KeyError が発生し、適切なエラーメッセージが表示される
- **テストメソッド:** test_validate_columns_missing_order_id

#### TC-FR001-006: 必須列検証（異常系: 会社名欠損）
- **優先度:** High
- **目的:** 会社名列が存在しない場合にエラーが発生することを確認
- **前提条件:** 会社名列を含まないCSV
- **入力:** 会社名列が欠けているCSVファイル
- **期待結果:** KeyError が発生し、適切なエラーメッセージが表示される
- **テストメソッド:** test_validate_columns_missing_company

#### TC-FR001-007: 必須列検証（異常系: 作業名称欠損）
- **優先度:** High
- **目的:** 作業名称列が存在しない場合にエラーが発生することを確認
- **前提条件:** 作業名称列を含まないCSV
- **入力:** 作業名称列が欠けているCSVファイル
- **期待結果:** KeyError が発生し、適切なエラーメッセージが表示される
- **テストメソッド:** test_validate_columns_missing_task_name

#### TC-FR001-008: CSV自動検出
- **優先度:** High
- **目的:** フォルダ内のCSVファイルを自動検出できることを確認
- **前提条件:** テストフォルダにCSVファイルが1つ以上存在
- **入力:** CSVファイルを含むフォルダパス
- **期待結果:** 最初のCSVファイルが検出される
- **テストメソッド:** test_auto_detect_csv

#### TC-FR001-009: ファイル不存在エラー
- **優先度:** High
- **目的:** 存在しないファイルを指定した場合にエラーが発生することを確認
- **前提条件:** 存在しないファイルパス
- **入力:** 存在しないCSVファイルパス
- **期待結果:** FileNotFoundError が発生
- **テストメソッド:** test_read_csv_file_not_found

---

### 3.2 FR-002: テキスト前処理

#### TC-FR002-001: スペース削除
- **優先度:** High
- **目的:** 全角・半角スペースが正しく削除されることを確認
- **入力:** "プロジェクト　名　テスト project name test"
- **期待結果:** "プロジェクト名テストprojectnametest"
- **テストメソッド:** test_remove_spaces

#### TC-FR002-002: 時期情報除去（FY2024）
- **優先度:** High
- **目的:** FY2024形式の時期情報が除去されることを確認
- **入力:** "FY2024在庫管理システム"
- **期待結果:** "在庫管理システム"
- **テストメソッド:** test_remove_period_fy

#### TC-FR002-003: 時期情報除去（令和6年度）
- **優先度:** High
- **目的:** 令和6年度形式の時期情報が除去されることを確認
- **入力:** "令和6年度在庫管理システム"
- **期待結果:** "在庫管理システム"
- **テストメソッド:** test_remove_period_reiwa

#### TC-FR002-004: 時期情報除去（5月度）
- **優先度:** High
- **目的:** 月度情報が除去されることを確認
- **入力:** "5月度在庫管理システム"
- **期待結果:** "在庫管理システム"
- **テストメソッド:** test_remove_period_monthly

#### TC-FR002-005: 時期情報除去（1Q）
- **優先度:** High
- **目的:** 四半期情報が除去されることを確認
- **入力:** "1Q在庫管理システム"
- **期待結果:** "在庫管理システム"
- **テストメソッド:** test_remove_period_quarterly

#### TC-FR002-006: フェーズ情報除去（要件定義）
- **優先度:** High
- **目的:** フェーズ情報が除去されることを確認
- **入力:** "要件定義/在庫管理システム"
- **期待結果:** "在庫管理システム"
- **テストメソッド:** test_remove_phase_japanese

#### TC-FR002-007: フェーズ情報除去（英語: BasicDesign）
- **優先度:** High
- **目的:** 英語フェーズ情報が除去されることを確認
- **入力:** "BasicDesign/在庫管理システム"
- **期待結果:** "在庫管理システム"
- **テストメソッド:** test_remove_phase_english

#### TC-FR002-008: フェーズ情報除去（略称: BD）
- **優先度:** High
- **目的:** フェーズ略称が除去されることを確認
- **入力:** "BD/在庫管理システム"
- **期待結果:** "在庫管理システム"
- **テストメソッド:** test_remove_phase_abbreviation

#### TC-FR002-009: 記号・装飾除去（長音記号保護）
- **優先度:** High
- **目的:** 記号が除去され、長音記号「ー」が保護されることを確認
- **入力:** "バージョン／アップ【テスト】"
- **期待結果:** "バージョンアップテスト"
- **テストメソッド:** test_remove_symbols_preserve_long_dash

#### TC-FR002-010: 半角→全角変換
- **優先度:** High
- **目的:** 半角英数字が全角に変換されることを確認
- **入力:** "ABC123"
- **期待結果:** "ＡＢＣ１２３"
- **テストメソッド:** test_normalize_width

#### TC-FR002-011: 略語正規化（S→システム）
- **優先度:** Medium
- **目的:** 略語が正規化されることを確認
- **入力:** "在庫管理S"
- **期待結果:** "在庫管理システム"
- **テストメソッド:** test_normalize_abbreviations

#### TC-FR002-012: 処理順序検証（v1.3最適化）
- **優先度:** High
- **目的:** 処理順序が最適化されていることを確認
- **入力:** "FY2024 バージョン／アップ 要件定義 5月度"
- **期待結果:** スペース削除→時期除去→フェーズ除去→記号除去→全角化の順で処理
- **テストメソッド:** test_processing_order

#### TC-FR002-013: 一括前処理
- **優先度:** High
- **目的:** 複数テキストを一括処理できることを確認
- **入力:** ["テキスト1", "テキスト2", "テキスト3"]
- **期待結果:** 3つの正規化されたテキストが返される
- **テストメソッド:** test_preprocess_batch

---

### 3.3 FR-003: TF-IDFベクトル化とクラスタリング

#### TC-FR003-001: デフォルトクラスタ数自動計算
- **優先度:** High
- **目的:** デンドログラムからクラスタ数が自動計算されることを確認
- **入力:** linkages配列、サンプル数10
- **期待結果:** 2〜5の範囲でクラスタ数が計算される
- **テストメソッド:** test_calculate_default_clusters

#### TC-FR003-002: クラスタ数計算（サンプル数2以下）
- **優先度:** Medium
- **目的:** サンプル数が2以下の場合に1クラスタになることを確認
- **入力:** サンプル数1
- **期待結果:** クラスタ数=1
- **テストメソッド:** test_calculate_default_clusters_small_sample

#### TC-FR003-003: 会社別クラスタリング
- **優先度:** High
- **目的:** 会社ごとに独立してクラスタリングが実行されることを確認
- **入力:** 複数会社のデータフレーム
- **期待結果:** 各会社ごとにクラスタIDが1から始まる
- **テストメソッド:** test_cluster_by_company

#### TC-FR003-004: クラスタID・代表名付与
- **優先度:** High
- **目的:** クラスタIDと代表名が正しく付与されることを確認
- **入力:** クラスタリング済みデータ
- **期待結果:** 各行にクラスタIDと代表名列が追加される
- **テストメソッド:** test_cluster_id_and_representative_name

---

### 3.4 FR-004: クラスタリング結果の出力

#### TC-FR004-001: CSV出力（UTF-8 with BOM）
- **優先度:** High
- **目的:** UTF-8 with BOMエンコーディングで出力されることを確認
- **入力:** データフレーム
- **期待結果:** UTF-8 with BOM形式のCSVファイルが生成される
- **テストメソッド:** test_write_csv_encoding

#### TC-FR004-002: タイムスタンプ付きファイル名
- **優先度:** High
- **目的:** タイムスタンプがファイル名に付与されることを確認
- **入力:** output_prefix="result", add_timestamp=True
- **期待結果:** "result_YYYYMMDD_HHMMSS.csv" 形式のファイル名
- **テストメソッド:** test_write_csv_timestamp

#### TC-FR004-003: タイムスタンプなしファイル名
- **優先度:** Medium
- **目的:** タイムスタンプなしで出力できることを確認
- **入力:** output_prefix="result", add_timestamp=False
- **期待結果:** "result.csv" のファイル名
- **テストメソッド:** test_write_csv_no_timestamp

#### TC-FR004-004: クラスタID・代表名列の追加
- **優先度:** High
- **目的:** 出力CSVにクラスタIDと代表名列が追加されることを確認
- **入力:** クラスタリング済みデータフレーム
- **期待結果:** 元の列 + クラスタID + 代表名
- **テストメソッド:** test_output_columns

---

### 3.5 FR-005: 設定ファイル（config.yaml）管理

#### TC-FR005-001: 設定ファイル読み込み
- **優先度:** High
- **目的:** config.yamlが正しく読み込まれることを確認
- **入力:** 有効なconfig.yaml
- **期待結果:** 設定値が正しく取得できる
- **テストメソッド:** test_config_load

#### TC-FR005-002: デフォルト値適用
- **優先度:** High
- **目的:** 設定項目が存在しない場合にデフォルト値が使用されることを確認
- **入力:** 一部の設定項目のみを含むconfig.yaml
- **期待結果:** 未設定項目にデフォルト値が適用される
- **テストメソッド:** test_config_defaults

#### TC-FR005-003: 前処理オプション反映
- **優先度:** High
- **目的:** preprocessing設定が前処理に反映されることを確認
- **入力:** remove_spaces=false のconfig
- **期待結果:** スペース削除が実行されない
- **テストメソッド:** test_preprocessing_config

---

### 3.6 FR-006: ログ出力

#### TC-FR006-001: コンソールログ出力
- **優先度:** Medium
- **目的:** コンソールにログが出力されることを確認
- **入力:** logging.console=true
- **期待結果:** コンソールにログメッセージが表示される
- **テストメソッド:** test_console_logging

#### TC-FR006-002: ファイルログ出力
- **優先度:** Medium
- **目的:** ファイルにログが出力されることを確認
- **入力:** logging.file=true
- **期待結果:** clustering.logファイルが生成される
- **テストメソッド:** test_file_logging

#### TC-FR006-003: ログレベル設定
- **優先度:** Medium
- **目的:** ログレベルが設定通りに動作することを確認
- **入力:** logging.level="WARNING"
- **期待結果:** WARNING以上のログのみが出力される
- **テストメソッド:** test_log_level

---

### 3.7 FR-007: 企業別クラスタ数調整

#### TC-FR007-001: クラスタ数自動計算（設定なし）
- **優先度:** High
- **目的:** 設定がない企業は自動計算されることを確認
- **入力:** company_cluster_settingsに記載がない企業
- **期待結果:** calculate_default_clusters()の値が使用される
- **テストメソッド:** test_get_cluster_count_auto

#### TC-FR007-002: オフセットモード（+2）
- **優先度:** High
- **目的:** "+2"指定で自動計算値+2になることを確認
- **入力:** "みらい銀行": "+2", 自動計算値=5
- **期待結果:** クラスタ数=7
- **テストメソッド:** test_get_cluster_count_offset_plus

#### TC-FR007-003: オフセットモード（-1）
- **優先度:** High
- **目的:** "-1"指定で自動計算値-1になることを確認
- **入力:** "ABC株式会社": "-1", 自動計算値=8
- **期待結果:** クラスタ数=7
- **テストメソッド:** test_get_cluster_count_offset_minus

#### TC-FR007-004: 固定モード（7）
- **優先度:** High
- **目的:** 数値指定で固定値になることを確認
- **入力:** "東京システム株式会社": 7, 自動計算値=6
- **期待結果:** クラスタ数=7
- **テストメソッド:** test_get_cluster_count_fixed

#### TC-FR007-005: クラスタ数下限制御（1以上）
- **優先度:** High
- **目的:** クラスタ数が1未満にならないことを確認
- **入力:** "-10"指定、自動計算値=3
- **期待結果:** クラスタ数=1（max(1, 3-10)）
- **テストメソッド:** test_get_cluster_count_minimum

#### TC-FR007-006: 企業名の完全一致
- **優先度:** High
- **目的:** 企業名が完全一致で判定されることを確認
- **入力:** "みらい銀行"の設定、"みらい銀行 "（スペース付き）でクエリ
- **期待結果:** 設定が適用されない（完全一致しない）
- **テストメソッド:** test_company_exact_match

---

### 3.8 FR-008: .exe化（PyInstaller）

#### TC-FR008-001: ビルド成功
- **優先度:** High
- **目的:** PyInstallerでビルドが成功することを確認
- **入力:** pyinstaller build.spec
- **期待結果:** dist/clustering.exeが生成される
- **テストメソッド:** 手動テスト

#### TC-FR008-002: .exe実行
- **優先度:** High
- **目的:** 生成された.exeが実行可能であることを確認
- **入力:** clustering.exe
- **期待結果:** エラーなく実行され、出力CSVが生成される
- **テストメソッド:** 手動テスト（Windows環境）

---

## 4. 非機能要件テストケース

### 4.1 NFR-001: パフォーマンス

#### TC-NFR001-001: 1000行CSVの処理時間
- **優先度:** High
- **目的:** 1000行のCSVを30秒以内に処理できることを確認
- **前提条件:** 1000行のテストデータが存在
- **入力:** 1000行のCSVファイル
- **期待結果:** 処理時間が30秒以内
- **テストメソッド:** test_performance_1000_rows

---

### 4.2 NFR-003: セキュリティ

#### TC-NFR003-001: 入力検証（不正なCSV）
- **優先度:** High
- **目的:** 不正なCSVフォーマットでエラーハンドリングされることを確認
- **入力:** 不正なフォーマットのCSVファイル
- **期待結果:** 適切なエラーメッセージが表示される
- **テストメソッド:** test_invalid_csv_format

#### TC-NFR003-002: 空データの処理
- **優先度:** Medium
- **目的:** 空のデータでもエラーが発生しないことを確認
- **入力:** 空の作業名称
- **期待結果:** エラーなく処理され、空文字列として扱われる
- **テストメソッド:** test_empty_data_handling

---

### 4.3 NFR-006: ユーザビリティ

#### TC-NFR006-001: エラーメッセージの明確性
- **優先度:** Medium
- **目的:** エラーメッセージがわかりやすいことを確認
- **入力:** 必須列欠損CSV
- **期待結果:** "必須列が存在しません: 作業名称" など具体的なメッセージ
- **テストメソッド:** test_error_message_clarity

#### TC-NFR006-002: ログ出力の妥当性
- **優先度:** Medium
- **目的:** ログに処理進捗が適切に出力されることを確認
- **入力:** 正常な処理フロー
- **期待結果:** 開始/完了/進捗ログが出力される
- **テストメソッド:** test_log_output

---

## 5. 統合テストケース

### 5.1 エンドツーエンドテスト

#### TC-INT-001: 正常系フルフロー
- **優先度:** Critical
- **目的:** CSV読み込み→前処理→クラスタリング→出力の全フローが動作することを確認
- **入力:** test_sample.csv
- **期待結果:**
  - 正常に実行完了
  - 出力CSVが生成される
  - クラスタID・代表名が付与されている
- **テストメソッド:** test_end_to_end_processing

#### TC-INT-002: 異常系: 入力ファイル不存在
- **優先度:** High
- **目的:** 入力ファイルが存在しない場合のエラーハンドリングを確認
- **入力:** 存在しないファイルパス
- **期待結果:** FileNotFoundError、適切なエラーメッセージ
- **テストメソッド:** test_error_missing_file

#### TC-INT-003: 異常系: 必須列欠損
- **優先度:** High
- **目的:** 必須列が欠損している場合のエラーハンドリングを確認
- **入力:** test_invalid.csv（必須列欠損）
- **期待結果:** KeyError、適切なエラーメッセージ
- **テストメソッド:** test_error_missing_columns

#### TC-INT-004: 異常系: 不正なconfig.yaml
- **優先度:** High
- **目的:** 不正な設定ファイルでエラーハンドリングされることを確認
- **入力:** 不正なYAML形式のconfig
- **期待結果:** エラーメッセージ、デフォルト設定で動作
- **テストメソッド:** test_error_invalid_config

#### TC-INT-005: main()関数の実行
- **優先度:** High
- **目的:** main()関数が正常に実行されることを確認
- **入力:** テストデータ、テスト設定
- **期待結果:** 終了コード0、出力ファイル生成
- **テストメソッド:** test_main_with_sample_data

---

## 6. テスト実行計画

### 6.1 実行順序

1. **単体テスト実行** (test_csv_reader.py, test_preprocessor.py, test_clustering.py)
2. **統合テスト実行** (test_integration.py)
3. **カバレッジ測定**
4. **テストレポート生成**

### 6.2 実行コマンド

```bash
# 全テスト実行
pytest tests/ -v

# カバレッジ測定
pytest tests/ --cov=src --cov-report=term-missing

# 特定モジュールのテスト
pytest tests/test_csv_reader.py -v
pytest tests/test_preprocessor.py -v
pytest tests/test_clustering.py -v
pytest tests/test_integration.py -v
```

---

## 7. 受け入れ基準

### 7.1 全体基準

- [ ] 全テストケースが合格（Pass）
- [ ] コードカバレッジ ≥ 80%
- [ ] クリティカルパス（統合テスト）が100%合格
- [ ] FR-001〜FR-008の全機能要件がテスト済み
- [ ] NFR-001（パフォーマンス）の基準を満たす

### 7.2 モジュール別基準

#### csv_reader.py
- [ ] UTF-8 BOM、Shift-JISの読み込みテスト合格
- [ ] エンコーディング自動検出テスト合格
- [ ] 必須列検証テスト合格
- [ ] CSV自動検出テスト合格

#### preprocessor.py
- [ ] 全前処理パターンテスト合格
- [ ] 処理順序検証テスト合格
- [ ] 長音記号保護テスト合格
- [ ] 一括処理テスト合格

#### clustering.py
- [ ] デフォルトクラスタ数計算テスト合格
- [ ] 企業別クラスタ数調整テスト合格（オフセット、固定）
- [ ] 会社別クラスタリングテスト合格
- [ ] クラスタID・代表名付与テスト合格

#### main.py（統合）
- [ ] エンドツーエンドテスト合格
- [ ] エラーハンドリングテスト合格
- [ ] 設定ファイル読み込みテスト合格

---

## 8. 変更履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|-----------|------|---------|--------|
| 1.0 | 2026-02-06 | 初版作成（包括的テストケース定義） | Tester SubAgent |

---

**以上、テストケース仕様書 v1.0**
